{% extends "homepage/layout.html" %}

{% load homepage_extras %}
{% load membrane_extras %}

{% block title %}Membranes{% endblock %}

{% block content %}

  <h1>Membranes</h1>
  <br>

  <p class="font-italic m-0 pl-1"><span class="font-weight-bold">N.B.:</span> If you use the following files in your
      work, please cite the primary source. (see Description field)</p>
  <div class="row bg-white border rounded border-success px-3 pt-3 mx-1">
    <div class="col-12 col-lg-7 table-responsive">
      <table class="table table-sm">
        <tbody>
          <tr><td class="font-weight-bold">Name:</td><td>{{ membranetopol.name }}</td></tr>
          <tr>
            <td class="font-weight-bold">Lipids:</td>
            <td>
              {% lipidnames membranetopol.topolcomposition_set.all as lipids %}
              {% for lip in lipids %}
                <a class="text-success" href="{% url 'lipdetail' lip.slug %}">
                    {{ lip.name }}{% if not forloop.last %},{% endif %}</a>
              {% endfor %}
            </td>
          </tr>
          <tr>
            <td class="font-weight-bold">Forcefield:</td>
            <td>
              <a class="text-success" href="{% url 'fflist' %}?ffid={{ membranetopol.forcefield.pk }}">
                  {{ membranetopol.forcefield }}</a>
            </td>
          </tr>
          <tr><td class="font-weight-bold">Software:</td><td>{{ membranetopol.software }}</td></tr>
          <tr>
            <td class="font-weight-bold">Files:</td>
            <td>
              {% if membrane.mem_file %}
                <a href="{{ membranetopol.mem_file.url }}" class="text-success" target="blank">
                    {{ membranetopol.mem_file.url|basename }}</a>,
              {% endif %}
              <a href="{{ membranetopol.compo_file.url }}" class="text-success" target="blank">
                  {{ membranetopol.compo_file.url|basename }}</a><br>
              <a href="{% url 'getfiles' %}?memid={{ membranetopol.pk }}" class="text-success">Simulation files</a>
            </td>
          </tr>
          <tr><td class="font-weight-bold">Number:</td><td>{{ membranetopol.nb_lipids }} lipids</td></tr>
          <tr><td class="font-weight-bold">Temperature:</td><td>{{ membranetopol.temperature }} Â°K</td></tr>
          <tr><td class="font-weight-bold">Equilibration:</td><td>{{ membranetopol.equilibration }} ns</td></tr>
          <tr><td class="font-weight-bold">Tags:</td><td>{{ membranetopol.membrane.tag.all|join:", " }}</td></tr>
          <tr><td class="font-weight-bold">Proteins:</td><td>{{ membranetopol.prot.all|join:", " }}</td></tr>
          <tr>
            <td><strong>Description:</strong></td>
            <td>{{ membranetopol.description|linebreaks }}</td>
          </tr>
          <tr>
            <td><strong>References:</strong></td>
            <td>
              {% for reference in membranetopol.reference.all %}
                <a class="text-success" href="http://dx.doi.org/{{ reference.doi }}">{{ reference.refid }}</a>
                <i>{{ reference.journal }}</i>, {{ reference.volume }}.
                {{ reference.title }}<br>
              {% endfor %}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="col-12 col-lg-5 align-self-center">
      <div id="viewport" class="viewport-mem"></div>
    </div>
    <div class="col-12 col-md-2 font-weight-bold">Composition:</div>
    <div class="col-6 col-md-4 ml-3">
      <span class="font-weight-bold">Upper leaflet 1</span><br>
      {% for lipid in membranetopol.topolcomposition_set.all|dictsortreversed:"number" %}
        {% if lipid.side == "UP" %}
          {{lipid.number}}
          <a class="text-success" href="{% url 'lipdetail' lipid.topology.lipid.slug %}">
              {{lipid.topology.lipid.name}}</a>
          (<a class="text-success" href="{% url 'toplist' %}?topid={{lipid.topology.pk}}">{{lipid.topology.version}}</a>)
          <br>
        {% endif %}
      {% endfor %}
    </div>
    <div class="col-6 col-md-5 ml-3">
      <span class="font-weight-bold">Lower leaflet 1</span><br>
      {% for lipid in membranetopol.topolcomposition_set.all|dictsortreversed:"number" %}
        {% if lipid.side == "LO" %}
          {{lipid.number}}
          <a class="text-success" href="{% url 'lipdetail' lipid.topology.lipid.slug %}">
              {{lipid.topology.lipid.name}}</a>
          (<a class="text-success" href="{% url 'toplist' %}?topid={{lipid.topology.pk}}">{{lipid.topology.version}}</a>)
          <br>
        {% endif %}
      {% endfor %}
    </div>
    {% for i in 15|times %}
      <div class="col-12 col-md-2"></div>
      <div class="col-6 col-md-4 ml-3">
        {% with y=forloop.counter|stringformat:"s" %}
        {% with bool=1 %}
        {% for lipid in membranetopol.topolcomposition_set.all|dictsortreversed:"number" %}
          {% if lipid.side == "UP"|add:y %}
            {% if bool %}
              {% boolean bool as bool %}
              <br>
              <span class="font-weight-bold">Upper leaflet {{y}}</span><br>
            {% endif %}
            {{lipid.number}}
            <a class="text-success" href="{% url 'lipdetail' lipid.topology.lipid.slug %}">
                {{lipid.topology.lipid.name}}</a>
            (<a class="text-success" href="{% url 'toplist' %}?topid={{lipid.topology.pk}}">{{lipid.topology.version}}</a>)
            <br>
          {% endif %}
        {% endfor %}
        {% endwith %}
        {% endwith %}
      </div>
      <div class="col-6 col-md-5 ml-3">
        {% with y=forloop.counter|stringformat:"s" %}
        {% with bool=1 %}
        {% for lipid in membranetopol.topolcomposition_set.all|dictsortreversed:"number" %}
          {% if lipid.side == "LO"|add:y %}
            {% if bool %}
              {% boolean bool as bool %}
              <br>
              <span class="font-weight-bold">Lower leaflet {{y}}</span><br>
            {% endif %}
            {{lipid.number}}
            <a class="text-success" href="{% url 'lipdetail' lipid.topology.lipid.slug %}">
                {{lipid.topology.lipid.name}}</a>
            (<a class="text-success" href="{% url 'toplist' %}?topid={{lipid.topology.pk}}">{{lipid.topology.version}}</a>)
            <br>
          {% endif %}
        {% endfor %}
        {% endwith %}
        {% endwith %}
      </div>
    {% endfor %}
    <div class="col-12 col-md-2"></div>
    <div class="col-6 col-md-4 ml-3">
      {% with bool=1 %}
      {% for lipid in membranetopol.topolcomposition_set.all|dictsortreversed:"number" %}
        {% if lipid.side == "UNK" %}
          {% if bool %}
            {% boolean bool as bool %}
            <br>
            <span class="font-weight-bold">Not in leaflet</span><br>
          {% endif %}
          {{lipid.number}}
          <a class="text-success" href="{% url 'lipdetail' lipid.topology.lipid.slug %}">
              {{lipid.topology.lipid.name}}</a>
          (<a class="text-success" href="{% url 'toplist' %}?topid={{lipid.topology.pk}}">{{lipid.topology.version}}</a>)
          <br>
        {% endif %}
      {% endfor %}
      {% endwith %}
    </div>
    <div class="col-6 p-3">
      {% if user.is_authenticated %}
        {% if user == membranetopol.curator %}
          <a href="{% url 'memupdate' membranetopol.pk %}"><i class="fas fa-edit text-success"></i></a>
          &nbsp
          <a href="{% url 'memdelete' membranetopol.pk %}"><i class="fas fa-trash text-success"></i></a>
        {% else %}
          <a href="{% url 'mail' %}?lipid={{ membranetopol.pk }}"><i class="fas fa-edit text-success"></i></a>
        {% endif %}
      {% endif %}
    </div>
    <div class="col-auto ml-auto align-self-end">
      <small>
        <b>Curator:</b>
        <a class="text-success" href="{% url 'userdetail' membranetopol.curator.pk %}">
            {{ membranetopol.curator.get_full_name }}</a> on {{ membranetopol.date }}
      </small>
    </div>
  </div>
  <br>

  <h2>Comments</h2>
  <div class="row bg-white border rounded border-success p-3 mx-1">
    <div class="col-12 comments">
      {% for comment in comments %}
        {{ comment.comment }}<br>
        <p class="text-right p-0"><small class="text-secondary">{{ comment.user.get_full_name }} on {{ comment.date }}</small><p>
        {% if not forloop.last %}<hr>{% endif %}
      {% endfor %}
      {% if comments|length == 0 %}
        No comments yet<br>
      {% endif %}
    </div>
    {% if user.is_authenticated %}
      <form method="post">
        {% csrf_token %}
        <div class="col-12 pt-2">
          <textarea id="{{ form.comment.id_for_label }}" name="{{ form.comment.html_name }}" class="form-control bg-light" rows="2" cols="110"></textarea>
          {% if form.comment.help_text %}<small class="text-secondary">{{ form.comment.help_text }}<br></small>{% endif %}
          {% for error in form.comment.errors %}<span class="text-danger">{{ error }}<br></span>{% endfor %}
          <button type="submit" class="btn btn-primary btn-sm mt-2">Add</button>
        </div>
      </form>
    {% endif %}
  </div>
  <br>

{% endblock %}


{% block script %}

  <script>
    $(document).ready(function(){
      $(".comments").scrollTop($(".comments")[0].scrollHeight);
    });
    var mem_file = "{{ mem_file }}";
    if (mem_file) {
      var name = "{{ mem_file|basename }}";
      var data = "../..{{ mem_file|dirname }}/";
      var rep = "{{ rep }}"
      NGL.DatasourceRegistry.add("data", new NGL.StaticDatasource(data))
      var stage;
      document.addEventListener("DOMContentLoaded", function () {
        stage = new NGL.Stage('viewport')
        // Handle window resizing
        window.addEventListener( "resize", function( event ){
          stage.handleResize();
        }, false );
        stage.loadFile("data://"+name).then(function (o) {
          var e = new NGL.Euler( 4.71, 0, 0 );
          var q = new NGL.Quaternion().setFromEuler( e );
          o.setRotation( q );
          o.addRepresentation(rep)
          o.autoView()
        })
      })
    }
  </script>

{% endblock %}
