{% extends "homepage/layout.html" %}

{% load homepage_extras %}
{% load forcefield_extras %}

{% block title %}Topologies{% endblock %}

{% block description %}
  molecular dynamics lipid topologies repository of limonada
{% endblock %}

{% block content %}

  <!-- Title -->
  <div class="row align-items-center justify-content-between">
    <div class="col-auto"><h1>Topologies</h1></div>
    <div class="col-auto">
      {% if user.is_authenticated %}
        <a href="{% url 'topcreate' %}" class="btn btn-primary" role="button">Add</a>
      {% endif %}
    </div>
  </div>
  <br>

  <!-- Search form -->
  <p class="font-italic m-0 pl-1"><span class="font-weight-bold">N.B.:</span> If you use the following files in your
      work, please cite the primary source. (see Description field)</p>
  <div class="row justify-content-between bg-green rounded-top border border-bottom-0 border-success p-3 mx-1">
    <div class="col-auto px-0">
        {% include 'per_page.html' %}
    </div>
    <div id="collapseselect" class="col-12 col-lg-8 order-last"
         {% if not params.software %}style="display: none"{% endif %}>
      <div class="container">
        <form id="select_form" method="get">
          <div class="row pt-1">
            {% for field in form_select %}
              {% if field.name == 'lipid' %} 
                <div class="col-auto p-1">{{ field.label_tag }}</div>
                <div class="col-8 col-xl-9 col-lg-10 col-md-10 col-sm-9 pb-1">
                  {{ field }}
                  {% if field.help_text %}<small class="text-secondary">{{ field.help_text }}<br></small>{% endif %}
                  {% for error in field.errors %}<span class="text-danger">{{ error }}<br></span>{% endfor %}
                </div>
              {% else %} 
                <div class="col-auto d-flex">
                  <div class="pr-2 py-1">{{ field.label_tag }}</div>
                  <div>
                    {% ff_select "all" as ffall %}
                    {% if field.name == 'software' %}
                      <select id="{{ field.id_for_label }}" name="{{ field.html_name }}" class="form-control"
                              onchange="populate({{ ffall }});">
                      {% for value,name in sfchoices %}
                        {% if params.software %}
                          <option value="{{ value }}" {% if value == params.software %}selected="selected"{% endif %}>
                            {{ name }}
                          </option>
                        {% else %}
                          <option value="{{ value }}" {% if value == "GR50" %}selected="selected"{% endif %}>
                            {{ name }}
                          </option>
                        {% endif %}
                      {% endfor %}
                      </select>
                    {% elif field.name == 'forcefield' %}
                      <select id="{{ field.id_for_label }}" name="{{ field.html_name }}" class="form-control">
                      {% if params.software %}
                        {% ff_select params.software as ffobjects %}
                      {% else %}
                        {% ff_select "GR50" as ffobjects %}
                      {% endif %}
                      {% if ffobjects %}
                        {% for value,name in ffobjects %}
                          <option value="{{ value }}"
                                  {% if value|slugify == params.forcefield %}selected="selected"{% endif %}>
                            {{ name }}
                          </option>
                        {% endfor %}
                      {% else %}
                        <option value="">---------</option>
                      {% endif %}
                      </select>
                    {% else %}
                      {{ field }}
                    {% endif %}
                    {% if field.help_text %}<small class="text-secondary">{{ field.help_text }}<br></small>{% endif %}
                    {% for error in field.errors %}<span class="text-danger">{{ error }}<br></span>{% endfor %}
                  </div>
                </div>
              {% endif %} 
            {% endfor %}
          </div>
          <a onclick="url_replace('software','forcefield','lipid')"
             class="btn btn-primary btn-sm text-white">Select</a>
        </form>
      </div>
    </div>
    <div class="col-auto ml-auto order-lg-last">
      <h2 class="text-info" id="clickselect"><i id="iconselect" class="fas fa-plus"></i></h2>
    </div>
  </div>

  <!-- Table -->
  <div class="row align-items-center bg-white border border-top-0 border-bottom-0 border-success p-3 mx-1">
    <div class="col-12 table-responsive">
      <table class="table table-sm">
        <thead>
          <tr>
            <th class="w-15">
              {% if sort == "version" %}
                {% if dir == "asc" %}
                  <i class="fas fa-sort-up"></i>
                {% else %}
                  <i class="fas fa-sort-down"></i>
                {% endif %}
              {% endif %}
              <a href="?{% url_replace sort="version" %}">Name</a></th>
            <th class="w-15">
              {% if sort == "forcefield" %}
                {% if dir == "asc" %}
                  <i class="fas fa-sort-up"></i>
                {% else %}
                  <i class="fas fa-sort-down"></i>
                {% endif %}
              {% endif %}
              <a href="?{% url_replace sort="forcefield" %}">Forcefield</a></th>
            <th class="w-25">
              {% if sort == "lipid" %}
                {% if dir == "asc" %}
                  <i class="fas fa-sort-up"></i>
                {% else %}
                  <i class="fas fa-sort-down"></i>
                {% endif %}
              {% endif %}
              <a href="?{% url_replace sort="lipid" %}">Lipid</a></th>
            <th class="w-15">
              {% if sort == "software" %}
                {% if dir == "asc" %}
                  <i class="fas fa-sort-up"></i>
                {% else %}
                  <i class="fas fa-sort-down"></i>
                {% endif %}
              {% endif %}
              <a href="?{% url_replace sort="software" %}">Software</a></th>
            <th class="w-20">Files</th>
            {% if user.is_authenticated %}
              <th class="w-10"></th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for topology in page_objects %}
            <tr>
              <td id="{{ topology.pk }}">
                <a class="text-success" href="{% url 'topdetail' topology.pk %}">
                    {{ topology.version }}_{{ topology.lipid.name }}</a>
              </td>
              <td>
                <a class="text-success" href="{% url 'fflist' %}?ffid={{ topology.forcefield.pk }}">
                    {{ topology.forcefield }}</a>
              </td>
              <td>
                <a class="text-success" href="{% url 'lipdetail' topology.lipid.slug %}">
                    {{ topology.lipid.name }} - {{ topology.lipid.com_name }}</a>
              </td>
              <td>{{ topology.get_software_display }}</td>
              <td>
                <a href="{{ topology.gro_file.url }}" class="text-success" target="blank">
                    {{ topology.gro_file.url|basename }}</a>,
                <a href="{{ topology.itp_file.url }}" class="text-success" target="blank">
                    {{ topology.itp_file.url|basename }}</a>
              </td>
              {% if user.is_authenticated %}
                {% if user == topology.curator %}
                  <td class="text-right">
                    <a href="{% url 'topupdate' topology.pk %}"><i class="fas fa-edit text-success"></i></a>
                    <a href="{% url 'topdelete' topology.pk %}"><i class="fas fa-trash text-success"></i></a>&nbsp
                  </td>
                {% else %}
                  <td class="text-right">
                    <a href="{% url 'mail' %}?topid={{ topology.pk }}"><i class="fas fa-edit text-success"></i></a>
                  </td>
                {% endif %}
              {% endif %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <div class="row bg-green rounded-bottom border border-top-0 border-success p-3 mx-1">
    {% include 'paginator.html' %}
  </div>
  <br>

{% endblock %}


{% block script %}

  <script>
    function populate(ffall){
      var val = document.getElementById("id_software").value;
      var s1  = document.getElementById("id_forcefield");
      while (s1.options.length > 0) {
        s1.remove(0);
      }
      var i = -1;
      if (ffall[val].length > 0) {
        for(var option in ffall[val]){
          i++;
          var newOption = document.createElement("option");
          newOption.value = ffall[val][i][0];
          newOption.innerHTML = ffall[val][i][1];
          s1.options.add(newOption);
        }
      } else {
        var newOption = document.createElement("option");
        newOption.value = "";
        newOption.innerHTML = "---------";
        s1.options.add(newOption);
      }
    }
  </script>
  {{ form_select.media }}

{% endblock %}
